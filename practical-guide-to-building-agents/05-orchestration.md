# 編排

有了基礎組件，您可以考慮編排模式，使您的代理能夠有效執行工作流程。

雖然立即建構具有複雜架構的完全自主代理很誘人，但客戶通常通過增量方法取得更大的成功。

一般來說，編排模式分為兩類：

### 01 單一代理系統
其中配備適當工具和指令的單一模型在循環中執行工作流程

### 02 多代理系統
其中工作流程執行分佈在多個協調的代理之間

讓我們詳細探討每種模式。

## 單一代理系統

單一代理可以通過逐步添加工具來處理許多任務，保持複雜性可管理並簡化評估和維護。每個新工具都擴展了其能力，而不會過早地迫使您編排多個代理。

![單一代理系統圖](https://via.placeholder.com/400x200?text=單一代理系統)

每種編排方法都需要「運行」的概念，通常作為循環實作，讓代理操作直到達到退出條件。常見的退出條件包括工具呼叫、某種結構化輸出、錯誤或達到最大輪數。

例如，在代理SDK中，代理使用 `Runner.run()` 方法啟動，該方法循環大型語言模型直到：

### 01 調用最終輸出工具，由特定輸出類型定義
### 02 模型返回沒有任何工具呼叫的回應（例如，直接的使用者訊息）

範例用法：
```python
Agents.run(agent, [UserMessage("What's the capital of the USA?")])
```

這個while循環的概念是代理功能的核心。在多代理系統中，正如您接下來將看到的，您可以有一系列工具呼叫和代理之間的移交，但允許模型運行多個步驟，直到滿足退出條件。

管理複雜性而不切換到多代理框架的有效策略是使用提示範本。與其為不同的使用案例維護眾多個別提示，不如使用接受政策變數的單一靈活基本提示。這種範本方法輕鬆適應各種上下文，顯著簡化維護和評估。隨著新使用案例的出現，您可以更新變數而不是重寫整個工作流程。

```
"你是呼叫中心代理。您正在與 {{user_first_name}} 互動，他已經是會員 {{user_tenure}}。使用者最常見的投訴是關於 {{user_complaint_categories}}。問候使用者，感謝他們成為忠實客戶，並回答使用者可能有的任何問題！"
```

## 何時考慮創建多個代理

我們的一般建議是首先最大化單一代理的能力。更多代理可以提供直觀的概念分離，但可能引入額外的複雜性和開銷，因此通常單一代理加工具就足夠了。

對於許多複雜的工作流程，將提示和工具分割到多個代理之間可以改善效能和可擴展性。當您的代理無法遵循複雜指令或持續選擇錯誤工具時，您可能需要進一步劃分您的系統並引入更多不同的代理。

分割代理的實際指導方針包括：

**複雜邏輯**  
當提示包含許多條件語句（多個 if-then-else 分支），並且提示範本變得難以擴展時，考慮將每個邏輯段分割到單獨的代理。

**工具過載**  
問題不僅僅是工具的數量，而是它們的相似性或重疊。一些實作成功管理超過15個定義良好、不同的工具，而其他實作則難以處理少於10個重疊工具。如果通過提供描述性名稱、清晰參數和詳細描述來改善工具清晰度不能改善效能，則使用多個代理。

## 多代理系統

雖然多代理系統可以針對特定工作流程和需求以多種方式設計，但我們與客戶的經驗突出了兩個廣泛適用的類別：

**管理者（代理作為工具）**  
中央「管理者」代理通過工具呼叫協調多個專門代理，每個處理特定任務或領域。

**去中心化（代理移交給代理）**  
多個代理作為對等體運行，根據其專長將任務移交給彼此。

多代理系統可以建模為圖形，代理表示為節點。在管理者模式中，邊緣代表工具呼叫，而在去中心化模式中，邊緣代表在代理之間轉移執行的移交。

無論編排模式如何，相同的原則適用：保持組件靈活、可組合，並由清晰、結構良好的提示驅動。

## 管理者模式

管理者模式使中央大型語言模型——「管理者」——能夠通過工具呼叫無縫編排專門代理網路。管理者不會失去上下文或控制，而是在正確的時間智能地將任務委派給正確的代理，毫不費力地將結果合成為有凝聚力的互動。這確保了順暢、統一的使用者體驗，專門能력始終按需可用。

此模式對於您只希望一個代理控制工作流程執行並可以存取使用者的工作流程是理想的。

![管理者模式圖](https://via.placeholder.com/400x200?text=管理者模式)

例如，以下是您可以在代理SDK中實作此模式的方法：

```python
from agents import Agent, Runner

manager_agent = Agent(
    name="manager_agent",
    instructions=(
        "你是翻譯代理。你使用給你的工具進行翻譯。"
        "如果被要求進行多次翻譯，你會呼叫相關工具。"
    ),
    tools=[
        spanish_agent.as_tool(
            tool_name="translate_to_spanish",
            tool_description="將使用者的訊息翻譯成西班牙文",
        ),
        french_agent.as_tool(
            tool_name="translate_to_french",
            tool_description="將使用者的訊息翻譯成法文",
        ),
        italian_agent.as_tool(
            tool_name="translate_to_italian",
            tool_description="將使用者的訊息翻譯成義大利文",
        ),
    ],
)

async def main():
    msg = input("將'hello'翻譯成西班牙文、法文和義大利文！")
    
    orchestrator_output = await Runner.run(manager_agent, msg)
    
    for message in orchestrator_output.new_messages:
        print(f" - 翻譯步驟: {message.content}")
```

### 宣告式與非宣告式圖形

一些框架是宣告式的，要求開發人員通過由節點（代理）和邊緣（確定性或動態移交）組成的圖形預先明確定義每個分支、循環和條件。雖然有益於視覺清晰度，但隨著工作流程變得更加動態和複雜，這種方法可能很快變得笨重和具有挑戰性，通常需要學習專門的領域特定語言。

相比之下，代理SDK採用更靈活的程式碼優先方法。開發人員可以使用熟悉的程式設計結構直接表達工作流程邏輯，而無需預先定義整個圖形，實現更動態和適應性的代理編排。

## 去中心化模式

在去中心化模式中，代理可以將工作流程執行「移交」給彼此。移交是允許代理委派給另一個代理的單向轉移。在代理SDK中，移交是一種工具或函數。如果代理呼叫移交函數，我們立即開始在被移交的新代理上執行，同時也轉移最新的對話狀態。

此模式涉及使用許多平等的代理，其中一個代理可以直接將工作流程的控制移交給另一個代理。當您不需要單一代理維持中央控制或合成時，這是最佳的——而是允許每個代理接管執行並根據需要與使用者互動。

![去中心化模式圖](https://via.placeholder.com/400x200?text=去中心化模式)

例如，以下是您如何使用代理SDK為處理銷售和支援的客戶服務工作流程實作去中心化模式：

```python
from agents import Agent, Runner

technical_support_agent = Agent(
    name="技術支援代理",
    instructions=(
        "您提供解決技術問題、系統故障或產品故障排除的專家協助。"
    ),
    tools=[search_knowledge_base]
)

sales_assistant_agent = Agent(
    name="銷售助理代理",
    instructions=(
        "您幫助企業客戶瀏覽產品目錄、推薦合適的解決方案並促進採購交易。"
    ),
    tools=[initiate_purchase_order]
)

order_management_agent = Agent(
    name="訂單管理代理",
    instructions=(
        "您協助客戶處理有關訂單追蹤、交付時間表以及處理退貨或退款的查詢。"
    ),
    tools=[track_order_status, initiate_refund_process]
)

triage_agent = Agent(
    name="分流代理",
    instructions="您作為第一個聯絡點，評估客戶查詢並迅速將其引導到正確的專門代理。",
    handoffs=[technical_support_agent, sales_assistant_agent, order_management_agent],
)

await Runner.run(
    triage_agent,
    input("您能否提供我們最近採購的交付時間表更新？")
)
```

在上面的範例中，初始使用者訊息被發送到 `triage_agent`。識別到輸入涉及最近的採購，`triage_agent` 會調用到 `order_management_agent` 的移交，將控制權轉移給它。

此模式對於對話分流等場景特別有效，或者當您偏好專門代理完全接管某些任務而不需要原始代理保持參與時。可選地，您可以為第二個代理配備回到原始代理的移交，允許它在必要時再次轉移控制權。
